---
# Source: stakater-push-main-tag-bitbucket/templates/task.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: stakater-push-main-tag-bitbucket
  labels:
    app.kubernetes.io/version: "0.0.0"
spec:
  params:
    - name: IMAGE_TAG
      type: string
      description: Reference of the image tag
    - name: PR_NUMBER
      type: string
      default: NA
      description: >-
        In case of PR, PR number that is to be used in image tag. If this field
        is empty it means that it's a commit on main branch
    - name: GIT_REVISION
      type: string
      description: The git revision
    - name: BITBUCKET_TOKEN
      type: string
      default: "git-auth"
      description: Secret that stores the Access Token and User Email for BitBucket
    - name: REPO_PATH
      type: string
      description: Name of Bitbucket project and Repository
    - name: userHome
      description: |
        Absolute path to the user's home directory.
      type: string
      default: "/home/git"
  steps:
    - args:
        - '-c'
        - >
          set -e
          set -x

          if [ "${WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND}" = "true" ] ; then
            cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.git-credentials" "${PARAM_USER_HOME}/.git-credentials"
            cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.gitconfig" "${PARAM_USER_HOME}/.gitconfig"
            chmod 400 "${PARAM_USER_HOME}/.git-credentials"
            chmod 400 "${PARAM_USER_HOME}/.gitconfig"
          fi

          if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
            cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
            chmod 700 "${PARAM_USER_HOME}"/.ssh
            chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
          fi


          git config --global --add safe.directory $(workspaces.source.path)

          BRANCH=$(git branch --show-current)

          sleep 7000
          
          if [ $(params.PR_NUMBER) == "NA" ] && \
           ( [ $BRANCH == "main" ] || [ $BRANCH == "master" ] ); then
            git tag -am "Bump version to $(params.IMAGE_TAG)" $(params.IMAGE_TAG)
            git push --tags
          else
            echo "Not on main/master branch. You are on branch $BRANCH"
          fi
          
      command:
        - /bin/bash
      image: 'stakater/pipeline-toolbox:v0.0.36'
      name: push-main-tag
      resources: {}
      workingDir: $(workspaces.source.path)
      env:
        - name: HOME
          value: "$(params.userHome)"
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
          value: $(workspaces.basic-auth.bound)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
          value: $(workspaces.basic-auth.path)
  workspaces:
    - name: source
    - name: ssh-directory
      optional: true
    - name: basic-auth
      optional: true